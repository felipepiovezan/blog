<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.66">
<title data-react-helmet="true">Static variables, static storage, static initialization, constant initialization, constinit, constexpr | 101</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Static variables, static storage, static initialization, constant initialization, constinit, constexpr | 101"><meta data-react-helmet="true" name="description" content="In a recent discussion over Twitter, it was pointed out that optimizers"><meta data-react-helmet="true" property="og:description" content="In a recent discussion over Twitter, it was pointed out that optimizers"><meta data-react-helmet="true" property="og:url" content="https://felipepiovezan.github.io//20200306-static_var/README"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://felipepiovezan.github.io//20200306-static_var/README"><link rel="stylesheet" href="/styles.58710d0f.css">
<link rel="preload" href="/styles.9959f271.js" as="script">
<link rel="preload" href="/runtime~main.5df455bb.js" as="script">
<link rel="preload" href="/main.01c6edad.js" as="script">
<link rel="preload" href="/1.43c5d01a.js" as="script">
<link rel="preload" href="/2.cf4e590e.js" as="script">
<link rel="preload" href="/13.c5726d0f.js" as="script">
<link rel="preload" href="/935f2afb.584f3aef.js" as="script">
<link rel="preload" href="/17896441.2afc73b6.js" as="script">
<link rel="preload" href="/7327e912.34065dcc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Blog</strong></a><a href="https://github.com/felipepiovezan" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://twitter.com/fpiovezan" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><a href="https://linkedin.com/in/felipepiovezan" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">LinkedIn</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Blog</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://github.com/felipepiovezan" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://twitter.com/fpiovezan" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li><li class="menu__list-item"><a href="https://linkedin.com/in/felipepiovezan" target="_blank" rel="noopener noreferrer" class="menu__link">LinkedIn</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLinkText_2zSB">About me</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/">About me</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLinkText_2zSB">Posts</a><ul class="menu__list"><li class="menu__list-item"><a href="https://felipepiovezan.github.io/cpp_abstract_machine/cpp_abstract_machine" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="0">The C++ abstract machine [opens in new tab]</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/20200503-git_intro/README">A Git introduction with no commands</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/20200306-static_var/README">Static variables, static storage, static initialization, constant initialization, constinit, constexpr</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/20200222-build_systems2/README">Build system basics - part 2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/20200127-build_systems1/README">Build system basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/20191117-improve_spam/README">Topological sorting - ACM-ICPC</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Static variables, static storage, static initialization, constant initialization, constinit, constexpr</h1></header><div class="markdown"><p>In a recent discussion over Twitter, it was pointed out that optimizers
failed to eliminate a function-scope static variable with no uses. This article
explores why the optimizer struggles with such code patterns, how static
variables are stored and initialized, and also how certain C++ keywords can
help the optimizer do its job.</p><p>Disclaimer: Godbolt links will be used but, instead of inspecting x86 assembly,
the target will be LLVM&#x27;s Intermediate Representation (IR). It is almost always
simpler to use IR instead of assembly:</p><ul><li>Most operations and types are spelled out explicitly.</li><li>The data section is easier to visualize.</li><li>The compiler transformations we&#x27;re interested in are, more often than not,
architecture-independent and happen before the compiler generates assembly.
Therefore we can keep a higher level of abstraction (IR) that is easier to
reason about.</li><li>We get to see what the compiler does to obey the C++ standard much earlier:
all the rules must be captured in the translation from C++ to IR and, from
there on, all optimizations are game - the standard doesn&#x27;t exist anymore.</li></ul><p>Everything necessary about IR will be explained, but if you want to learn more,
I presented <a href="https://www.youtube.com/watch?v=m8G_S5LwlTo" target="_blank" rel="noopener noreferrer">a tutorial</a> during the EuroLLVM developers conference in 2019.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-offending-code"></a>The offending code.<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-offending-code" title="Direct link to heading">#</a></h2><p>The <a href="https://twitter.com/lefticus/status/1221943946311454721" target="_blank" rel="noopener noreferrer">original tweet</a> used this example:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token macro property">#</span><span class="token macro property directive keyword" style="font-style:italic">include</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&lt;string&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">static_version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">string unused_variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;static&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">42</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">local_version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> std</span><span class="token operator" style="color:rgb(137, 221, 255)">::</span><span class="token plain">string unused_variable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;local&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">42</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p>The author mentions how, in the static case, <code>unused_variable</code> doesn&#x27;t get
optimized away but, in the local variable case, the optimizer does a much
better job.</p><p>Because <code>std::string</code> has a complicated constructor, I&#x27;ll rewrite this code
using the simplest class possible:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">State</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">State</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">get_value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> State optimize_me</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">42</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p>It&#x27;s reasonable to expect that <code>State optimize_me</code> will be optimized away: it
is a function-scope static variable with no uses. Unfortunately, both GCC and
Clang fail to do so.</p><p>To understand what&#x27;s going here, let&#x27;s look at the <a href="https://godbolt.org/z/AGa_4M" target="_blank" rel="noopener noreferrer">IR produced by Clang</a> without
optimizations<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p><p>First, a type <code>struct.State</code> is defined:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">%struct.State = type { i8 }</span></div></div></div></div></div><p>Our C++ struct has no data members, and yet its equivalent in IR contains an
8-bit integer (<code>i8</code>). What is <code>sizeof(State)</code>? Having seen the IR, the answer is
easy to guess: 1 byte <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup>.</p><p>Then, a global variable of that type is defined and initialized:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@_ZZ10get_value2vE11optimize_me = internal global %struct.State zeroinitializer</span></div></div></div></div></div><p>Note that this variable is initialized with the <code>zeroinitializer</code> keyword. That
means its memory region will be set to zero  <strong>before the program starts</strong>.
But... We haven&#x27;t initialized our C++ variable at all! We&#x27;ll talk more about
this later.</p><p>There is another global variable in our module, with a very similar name:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@_ZGVZ10get_value2vE11optimize_me = internal global i8 0</span></div></div></div></div></div><p>Note again how this variable is zero initialized, this time by writing <code>i8 0</code>
(this is equivalent to <code>zeroinitializer</code>).</p><p>This is very mysterious: an 8-bit integer that we never wrote in the original
C++ code. Let&#x27;s look at the body of our <code>get_value</code> function to find out more:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">define i32 @_Z10get_valuev() #0 {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  %1 = load i8, i8* @_ZGVZ10get_value2vE11optimize_me</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  %2 = icmp eq i8 %1, 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  br i1 %2, label %3, label %4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>The first line loads the mysterious variable and the second line compares it
to 0. If the value is zero, the code branches to this block:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">3:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call void @_ZN5StateC2Ev(%struct.State* @_ZZ10get_value2vE11optimize_me)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  store i8 1, i8* @_ZGVZ10get_value2vE11optimize_me</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  br label %4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div></div></div><p>A function call with our static variable as its first argument -- this is a
call to <code>State</code>&#x27;s constructor! Right after that, we update the value of the
mysterious variable by storing <code>1</code> to it.</p><p>Afterwards, or if the original comparison to zero failed, code execution
proceeds to return <code>42</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">4:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ret i32 42</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>A visual representation can be found in the <a href="https://en.wikipedia.org/wiki/Control-flow_graph" target="_blank" rel="noopener noreferrer">control flow graph</a> for this
function:</p><p><img alt="example 1" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gR2VuZXJhdGVkIGJ5IGdyYXBodml6IHZlcnNpb24gMi40Mi4zICgwKQogLS0+Cgo8IS0tIFRpdGxlOiBDRkcgZm9yICYjMzk7X1o5Z2V0X3ZhbHVldiYjMzk7IGZ1bmN0aW9uIFBhZ2VzOiAxIC0tPgoKPHN2ZwogICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiCiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIKICAgeG1sbnM6c3ZnPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiCiAgIHhtbG5zOmlua3NjYXBlPSJodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy9uYW1lc3BhY2VzL2lua3NjYXBlIgogICB3aWR0aD0iNjg0cHQiCiAgIGhlaWdodD0iMzU0LjM2MnB0IgogICB2aWV3Qm94PSIwIDAgNjg0IDM1NC4zNjIiCiAgIHZlcnNpb249IjEuMSIKICAgaWQ9InN2Zzc3IgogICBzb2RpcG9kaTpkb2NuYW1lPSJjZmcuc3ZnIgogICBpbmtzY2FwZTp2ZXJzaW9uPSIwLjkyLjQgNWRhNjg5YzMxMywgMjAxOS0wMS0xNCI+CiAgPG1ldGFkYXRhCiAgICAgaWQ9Im1ldGFkYXRhODMiPgogICAgPHJkZjpSREY+CiAgICAgIDxjYzpXb3JrCiAgICAgICAgIHJkZjphYm91dD0iIj4KICAgICAgICA8ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD4KICAgICAgICA8ZGM6dHlwZQogICAgICAgICAgIHJkZjpyZXNvdXJjZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0eXBlL1N0aWxsSW1hZ2UiIC8+CiAgICAgICAgPGRjOnRpdGxlIC8+CiAgICAgIDwvY2M6V29yaz4KICAgIDwvcmRmOlJERj4KICA8L21ldGFkYXRhPgogIDxkZWZzCiAgICAgaWQ9ImRlZnM4MSIgLz4KICA8c29kaXBvZGk6bmFtZWR2aWV3CiAgICAgcGFnZWNvbG9yPSIjZmZmZmZmIgogICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICAgIGJvcmRlcm9wYWNpdHk9IjEiCiAgICAgb2JqZWN0dG9sZXJhbmNlPSIxMCIKICAgICBncmlkdG9sZXJhbmNlPSIxMCIKICAgICBndWlkZXRvbGVyYW5jZT0iMTAiCiAgICAgaW5rc2NhcGU6cGFnZW9wYWNpdHk9IjAiCiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIKICAgICBpbmtzY2FwZTp3aW5kb3ctd2lkdGg9IjE5MTYiCiAgICAgaW5rc2NhcGU6d2luZG93LWhlaWdodD0iMTA0NSIKICAgICBpZD0ibmFtZWR2aWV3NzkiCiAgICAgc2hvd2dyaWQ9ImZhbHNlIgogICAgIGZpdC1tYXJnaW4tdG9wPSIxNSIKICAgICBmaXQtbWFyZ2luLWxlZnQ9IjE1IgogICAgIGZpdC1tYXJnaW4tcmlnaHQ9IjE1IgogICAgIGZpdC1tYXJnaW4tYm90dG9tPSIxNSIKICAgICBpbmtzY2FwZTp6b29tPSIwLjg0NzI0NDQzIgogICAgIGlua3NjYXBlOmN4PSIyMjYuMDU4NDMiCiAgICAgaW5rc2NhcGU6Y3k9IjE3My41NTQ4NCIKICAgICBpbmtzY2FwZTp3aW5kb3cteD0iMCIKICAgICBpbmtzY2FwZTp3aW5kb3cteT0iMTYiCiAgICAgaW5rc2NhcGU6d2luZG93LW1heGltaXplZD0iMCIKICAgICBpbmtzY2FwZTpjdXJyZW50LWxheWVyPSJsYXllcjIiIC8+CiAgPGcKICAgICBpbmtzY2FwZTpncm91cG1vZGU9ImxheWVyIgogICAgIGlkPSJsYXllcjIiCiAgICAgaW5rc2NhcGU6bGFiZWw9ImJnIj4KICAgIDxyZWN0CiAgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTojMDAwMDAwO3N0cm9rZS13aWR0aDowLjc1O3N0cm9rZS1vcGFjaXR5OjAuMDExNjI3OTIiCiAgICAgICBpZD0icmVjdDkzNCIKICAgICAgIHdpZHRoPSI2OTYuMDUyOTgiCiAgICAgICBoZWlnaHQ9IjM2NC4zMDExNSIKICAgICAgIHg9Ii0xLjI1MTg5NCIKICAgICAgIHk9Ii0zLjY3OTY2NzUiIC8+CiAgPC9nPgogIDxnCiAgICAgaWQ9ImdyYXBoMCIKICAgICBjbGFzcz0iZ3JhcGgiCiAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTUuNSwzMzkuODYyMDIpIj4KICAgIDx0aXRsZQogICAgICAgaWQ9InRpdGxlMiI+Q0ZHIGZvciAnX1o5Z2V0X3ZhbHVldicgZnVuY3Rpb248L3RpdGxlPgogICAgPCEtLSBOb2RlMHg1NWUxOTFlN2NhZDAgLS0+CiAgICA8IS0tIE5vZGUweDU1ZTE5MWU3Y2NkMCAtLT4KICAgIDwhLS0gTm9kZTB4NTVlMTkxZTdjYWQwJiM0NTsmZ3Q7Tm9kZTB4NTVlMTkxZTdjY2QwIC0tPgogICAgPCEtLSBOb2RlMHg1NWUxOTFlN2NkMjAgLS0+CiAgICA8IS0tIE5vZGUweDU1ZTE5MWU3Y2FkMCYjNDU7Jmd0O05vZGUweDU1ZTE5MWU3Y2QyMCAtLT4KICAgIDwhLS0gTm9kZTB4NTVlMTkxZTdjY2QwJiM0NTsmZ3Q7Tm9kZTB4NTVlMTkxZTdjZDIwIC0tPgogIDwvZz4KICA8ZwogICAgIGlua3NjYXBlOmdyb3VwbW9kZT0ibGF5ZXIiCiAgICAgaWQ9ImxheWVyMSIKICAgICBpbmtzY2FwZTpsYWJlbD0iTGF5ZXIgMSIKICAgICBzdHlsZT0iZGlzcGxheTppbmxpbmUiPgogICAgPHRleHQKICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1LjUsMzM5Ljg2MjAyKSIKICAgICAgIHg9IjM0MyIKICAgICAgIHk9Ii0zMTUuMzAwMDIiCiAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgaWQ9InRleHQ2IgogICAgICAgc3R5bGU9ImZvbnQtc2l6ZToxNHB4O2ZvbnQtZmFtaWx5OlRpbWVzLCBzZXJpZjt0ZXh0LWFuY2hvcjptaWRkbGUiPkNGRyBmb3IgJ2dldF92YWx1ZScgZnVuY3Rpb248L3RleHQ+CiAgICA8ZwogICAgICAgaWQ9Im5vZGUxIgogICAgICAgY2xhc3M9Im5vZGUiCiAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNS41LDM2Mi4zNjIwMikiPgogICAgICA8dGl0bGUKICAgICAgICAgaWQ9InRpdGxlOCI+Tm9kZTB4NTVlMTkxZTdjYWQwPC90aXRsZT4KICAgICAgPHBvbHlnb24KICAgICAgICAgcG9pbnRzPSI2NTMsLTMyNC41IDY1MywtMjMzLjUgMjQxLC0yMzMuNSAyNDEsLTMyNC41ICIKICAgICAgICAgaWQ9InBvbHlnb24xMCIKICAgICAgICAgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMCIgLz4KICAgICAgPHRleHQKICAgICAgICAgeD0iMjQ5IgogICAgICAgICB5PSItMjk0LjI5OTk5IgogICAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgICBpZD0idGV4dDE0IgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjE0cHg7Zm9udC1mYW1pbHk6VGltZXMsIHNlcmlmO3RleHQtYW5jaG9yOnN0YXJ0Ij4lMSA9IGxvYWQgaTgsIGk4KiBAX1pHVlo5Z2V0X3ZhbHVldkUxMW9wdGltaXplX21lPC90ZXh0PgogICAgICA8dGV4dAogICAgICAgICB4PSIyNDkiCiAgICAgICAgIHk9Ii0yNzkuMjk5OTkiCiAgICAgICAgIGZvbnQtc2l6ZT0iMTQuMDAiCiAgICAgICAgIGlkPSJ0ZXh0MTYiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6c3RhcnQiPiUyID0gaWNtcCBlcSBpOCAlMSwgMDwvdGV4dD4KICAgICAgPHRleHQKICAgICAgICAgeD0iMjQ5IgogICAgICAgICB5PSItMjY0LjI5OTk5IgogICAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgICBpZD0idGV4dDE4IgogICAgICAgICBzdHlsZT0iZm9udC1zaXplOjE0cHg7Zm9udC1mYW1pbHk6VGltZXMsIHNlcmlmO3RleHQtYW5jaG9yOnN0YXJ0Ij5iciBpMSAlMiwgbGFiZWwgJTMsIGxhYmVsICU0PC90ZXh0PgogICAgICA8cG9seWxpbmUKICAgICAgICAgcG9pbnRzPSIyNDEsLTI1Ni41IDY1MywtMjU2LjUgIgogICAgICAgICBpZD0icG9seWxpbmUyMCIKICAgICAgICAgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMCIgLz4KICAgICAgPHRleHQKICAgICAgICAgeD0iMzQ0IgogICAgICAgICB5PSItMjQxLjMiCiAgICAgICAgIGZvbnQtc2l6ZT0iMTQuMDAiCiAgICAgICAgIGlkPSJ0ZXh0MjIiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6bWlkZGxlIj5UPC90ZXh0PgogICAgICA8cG9seWxpbmUKICAgICAgICAgcG9pbnRzPSI0NDcsLTIzMy41IDQ0NywtMjU2LjUgIgogICAgICAgICBpZD0icG9seWxpbmUyNCIKICAgICAgICAgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMCIgLz4KICAgICAgPHRleHQKICAgICAgICAgeD0iNTUwIgogICAgICAgICB5PSItMjQxLjMiCiAgICAgICAgIGZvbnQtc2l6ZT0iMTQuMDAiCiAgICAgICAgIGlkPSJ0ZXh0MjYiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6bWlkZGxlIj5GPC90ZXh0PgogICAgPC9nPgogICAgPGcKICAgICAgIGlkPSJnODYxIj4KICAgICAgPGcKICAgICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTUuNSwzNjIuMzYyMDIpIgogICAgICAgICBjbGFzcz0ibm9kZSIKICAgICAgICAgaWQ9Im5vZGUyIj4KICAgICAgICA8dGl0bGUKICAgICAgICAgICBpZD0idGl0bGUyOSI+Tm9kZTB4NTVlMTkxZTdjY2QwPC90aXRsZT4KICAgICAgICA8cG9seWdvbgogICAgICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDAiCiAgICAgICAgICAgaWQ9InBvbHlnb24zMSIKICAgICAgICAgICBwb2ludHM9IjAsLTExMy41IDAsLTE5Ni41IDU3OCwtMTk2LjUgNTc4LC0xMTMuNSAiCiAgICAgICAgICAgdHJhbnNmb3JtPSJtYXRyaXgoMC44MDE1MDM1NiwwLDAsMS4wMDEzODQzLC0wLjA2ODU1NzYzLDAuMjE0NTU0NzIpIiAvPgogICAgICAgIDx0ZXh0CiAgICAgICAgICAgc3R5bGU9ImZvbnQtc2l6ZToxNHB4O2ZvbnQtZmFtaWx5OlRpbWVzLCBzZXJpZjt0ZXh0LWFuY2hvcjpzdGFydCIKICAgICAgICAgICBpZD0idGV4dDMzIgogICAgICAgICAgIGZvbnQtc2l6ZT0iMTQuMDAiCiAgICAgICAgICAgeT0iLTE4MS4zIgogICAgICAgICAgIHg9IjgiPiUzOjwvdGV4dD4KICAgICAgICA8dGV4dAogICAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6c3RhcnQiCiAgICAgICAgICAgaWQ9InRleHQzNyIKICAgICAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgICAgIHk9Ii0xNTAuMDQ4MTEiCiAgICAgICAgICAgeD0iOCI+Y2FsbCB2b2lkIEBfWk41U3RhdGVDMkV2KCVzdHJ1Y3QuU3RhdGUqIEBfWlo5Z2V0X3ZhbHVldkUxMW9wdGltaXplX21lKTwvdGV4dD4KICAgICAgICA8dGV4dAogICAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6c3RhcnQiCiAgICAgICAgICAgaWQ9InRleHQzOSIKICAgICAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgICAgIHk9Ii0xMzYuMyIKICAgICAgICAgICB4PSI4Ij5zdG9yZSBpOCAxLCBpOCogQF9aR1ZaOWdldF92YWx1ZXZFMTFvcHRpbWl6ZV9tZTwvdGV4dD4KICAgICAgICA8dGV4dAogICAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6c3RhcnQiCiAgICAgICAgICAgaWQ9InRleHQ0MSIKICAgICAgICAgICBmb250LXNpemU9IjE0LjAwIgogICAgICAgICAgIHk9Ii0xMjEuMyIKICAgICAgICAgICB4PSI4Ij5iciBsYWJlbCAlNDwvdGV4dD4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcKICAgICAgIGlkPSJlZGdlMSIKICAgICAgIGNsYXNzPSJlZGdlIgogICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTUuNSwzNjIuMzYyMDIpIj4KICAgICAgPHRpdGxlCiAgICAgICAgIGlkPSJ0aXRsZTQ0Ij5Ob2RlMHg1NWUxOTFlN2NhZDA6czAtJmd0O05vZGUweDU1ZTE5MWU3Y2NkMDwvdGl0bGU+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Im0gMzQ0LC0yMzMgYyAwLDkuNzUgLTIuOTYsMTkuMTMgLTcuNSwyNy43NyIKICAgICAgICAgaWQ9InBhdGg0NiIKICAgICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIKICAgICAgICAgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzAwMDAwMCIgLz4KICAgICAgPHBvbHlnb24KICAgICAgICAgcG9pbnRzPSIzMzkuNCwtMjAzLjI3IDMzMS4yNCwtMTk2LjUxIDMzMy40LC0yMDYuODggIgogICAgICAgICBpZD0icG9seWdvbjQ4IgogICAgICAgICBzdHlsZT0iZmlsbDojMDAwMDAwO3N0cm9rZTojMDAwMDAwIiAvPgogICAgPC9nPgogICAgPGcKICAgICAgIGlkPSJub2RlMyIKICAgICAgIGNsYXNzPSJub2RlIgogICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTUuNSwzNjIuMzYyMDIpIj4KICAgICAgPHRpdGxlCiAgICAgICAgIGlkPSJ0aXRsZTUxIj5Ob2RlMHg1NWUxOTFlN2NkMjA8L3RpdGxlPgogICAgICA8cG9seWdvbgogICAgICAgICBwb2ludHM9IjQ5MywtMjMuNSA0MDEsLTIzLjUgNDAxLC03Ni41IDQ5MywtNzYuNSAiCiAgICAgICAgIGlkPSJwb2x5Z29uNTMiCiAgICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDAiIC8+CiAgICAgIDx0ZXh0CiAgICAgICAgIHg9IjQwOSIKICAgICAgICAgeT0iLTYxLjI5OTk5OSIKICAgICAgICAgZm9udC1zaXplPSIxNC4wMCIKICAgICAgICAgaWQ9InRleHQ1NSIKICAgICAgICAgc3R5bGU9ImZvbnQtc2l6ZToxNHB4O2ZvbnQtZmFtaWx5OlRpbWVzLCBzZXJpZjt0ZXh0LWFuY2hvcjpzdGFydCI+JTQ6PC90ZXh0PgogICAgICA8dGV4dAogICAgICAgICB4PSI0MDkiCiAgICAgICAgIHk9Ii0zNy4yOTk5OTkiCiAgICAgICAgIGZvbnQtc2l6ZT0iMTQuMDAiCiAgICAgICAgIGlkPSJ0ZXh0NTkiCiAgICAgICAgIHN0eWxlPSJmb250LXNpemU6MTRweDtmb250LWZhbWlseTpUaW1lcywgc2VyaWY7dGV4dC1hbmNob3I6c3RhcnQiPnJldCBpMzIgNDI8L3RleHQ+CiAgICA8L2c+CiAgICA8ZwogICAgICAgaWQ9ImVkZ2UyIgogICAgICAgY2xhc3M9ImVkZ2UiCiAgICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNS41LDM2Mi4zNjIwMikiPgogICAgICA8dGl0bGUKICAgICAgICAgaWQ9InRpdGxlNjIiPk5vZGUweDU1ZTE5MWU3Y2FkMDpzMS0mZ3Q7Tm9kZTB4NTVlMTkxZTdjZDIwPC90aXRsZT4KICAgICAgPHBhdGgKICAgICAgICAgZD0ibSA1NTAsLTIzMyBjIDAsMjIuOTQgMjguMDcsMTQuODYgMzcsMzYgMTQuNTIsMzQuMzkgMjAuMzYsNTIuNzEgMCw4NCAtMTguNSwyOC40MiAtNTMuMzMsNDMuOTIgLTgzLjYyLDUyLjMxIgogICAgICAgICBpZD0icGF0aDY0IgogICAgICAgICBpbmtzY2FwZTpjb25uZWN0b3ItY3VydmF0dXJlPSIwIgogICAgICAgICBzdHlsZT0iZmlsbDpub25lO3N0cm9rZTojMDAwMDAwIiAvPgogICAgICA8cG9seWdvbgogICAgICAgICBwb2ludHM9IjUwMi4xMywtNjMuOTkgNTAzLjg3LC01Ny4yMSA0OTMuMzEsLTU4LjExICIKICAgICAgICAgaWQ9InBvbHlnb242NiIKICAgICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDtzdHJva2U6IzAwMDAwMCIgLz4KICAgIDwvZz4KICAgIDxnCiAgICAgICBpZD0iZWRnZTMiCiAgICAgICBjbGFzcz0iZWRnZSIKICAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1LjUsMzYyLjM2MjAyKSI+CiAgICAgIDx0aXRsZQogICAgICAgICBpZD0idGl0bGU2OSI+Tm9kZTB4NTVlMTkxZTdjY2QwLSZndDtOb2RlMHg1NWUxOTFlN2NkMjA8L3RpdGxlPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDM1MS40NSwtMTEzLjI5IGMgMTUuODYsMTAuMzQgMzIuNjUsMjEuMjkgNDcuNjcsMzEuMDciCiAgICAgICAgIGlkPSJwYXRoNzEiCiAgICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiCiAgICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7c3Ryb2tlOiMwMDAwMDAiIC8+CiAgICAgIDxwb2x5Z29uCiAgICAgICAgIHBvaW50cz0iNDA3LjczLC03Ni42IDM5Ny40NCwtNzkuMTMgNDAxLjI2LC04NC45OSAiCiAgICAgICAgIGlkPSJwb2x5Z29uNzMiCiAgICAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7c3Ryb2tlOiMwMDAwMDAiIC8+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4K"></p><p>This example illustrates the code generated in order to initialize
function-scope static variables. The compiler must guarantee that the
constructor is called exactly once, during the first time execution passes
through the static variable declaration. This is accomplished with the pattern:</p><ul><li>Global counter initialized to 0</li><li>If counter is zero:<ul><li>Call constructor.</li><li>Set counter to 1.</li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="optimized-code"></a>Optimized code<a aria-hidden="true" tabindex="-1" class="hash-link" href="#optimized-code" title="Direct link to heading">#</a></h2><p>Is the optimizer able to remove all of the code in that function?
<a href="https://godbolt.org/z/KMCFPD" target="_blank" rel="noopener noreferrer">Take a look</a>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@_ZGVZ9get_valuevE11optimize_me = internal unnamed_addr global i1 false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">define i32 @_Z9get_valuev() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  %1 = load i1, i1* @_ZGVZ9get_valuevE11optimize_me</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  br i1 %1, label %3, label %2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  store i1 true, i1* @_ZGVZ9get_valuevE11optimize_me</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  br label %3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ret i32 42</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>Note that the optimizer:</p><ol><li>Deleted the <em>static</em> variable.</li><li>Deleted the call to its constructor.</li><li>Transformed the global counter into a boolean (from <code>i8</code> to <code>i1</code>).</li><li>Failed to optimize away this global boolean.</li></ol><p>Point #4 is a hard problem because the counter will make the first call to
<code>get_value</code> take a different code path from subsequent calls. Furthermore,
the two paths have distinct behaviors: one writes to a global variable, the
other doesn&#x27;t. To delete the counter:</p><ol><li>The optimizer needs to prove that the change in the <strong>counter&#x27;s value</strong> isn&#x27;t
meaningful to the program.</li><li>But it is meaningful because it affects control flow inside <code>get_value</code>.</li><li>So the optimizer needs to prove that control flow inside <code>get_value</code> isn&#x27;t
meaningful to the program.</li><li>But it is meaningful because control flow affects the <strong>counter&#x27;s value</strong>.</li></ol><p>... And now we&#x27;re stuck in a loop! It&#x27;s not an unsolvable problem, but it
illustrates challenges the optimizer can&#x27;t overcome right now<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>.</p><p>This situation gets worse if the constructor call isn&#x27;t as simple as an empty
function. Our motivating example, <code>std::string</code>, definitely doesn&#x27;t have a
simple constructor.</p><p>##Can we do better ?</p><p>We can. We can help the compiler by expressing our intent more appropriately.
But first, we need to understand how static variables are initialized.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="static-storage"></a>Static storage<a aria-hidden="true" tabindex="-1" class="hash-link" href="#static-storage" title="Direct link to heading">#</a></h3><p>Static variables have what is known as static storage. From cppreference:</p><blockquote><p>The storage for the object is allocated when the program begins and
deallocated when the program ends. Only one instance of the object exists.</p></blockquote><p>In practice, we see the storage for static variables in the data segment of the
program, in other words, the storage is available when the program is
<strong>loaded</strong>. Moreover, the initial contents of that memory region are also
specified in the data segment and available when the program is loaded; but
what exactly are those contents and can we influence them?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="zero-or-constant-initialization"></a>Zero or Constant initialization<a aria-hidden="true" tabindex="-1" class="hash-link" href="#zero-or-constant-initialization" title="Direct link to heading">#</a></h3><p>Let&#x27;s look at what cppreference tells us (emphasis mine):</p><blockquote><p>Variables declared at block scope with the specifier static[...] are
initialized the first time control passes through their declaration( <strong>unless
their initialization is zero - or constant - initialization</strong>, which can be
performed before the block is first entered) . [<a href="https://en.cppreference.com/w/cpp/language/storage_duration#Static_local_variables" target="_blank" rel="noopener noreferrer">static local variables</a>]</p></blockquote><p>Intuitively, zero-initialization is what it sounds like: when the program is
loaded, that region of memory gets zero initialized. Typically, if other
initialization is necessary, like running constructors or evaluating
constructor arguments, it will happen at runtime. Not very exciting.</p><p>Constant-initialization, when possible, happens instead of zero-initialization.
The details are complicated, but it essentially boils down to whether you have
a constant expression initializing the static variable. Cppreference uses the
following notation to explain this idea:</p><blockquote><p><code>static T object = constexpr;</code></p></blockquote><p>The best part is that constant-initialization will typically remove the need
for runtime initialization. Let&#x27;s look at what this looks like in IR.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="constant-initialization-to-the-rescue"></a>Constant initialization to the rescue!<a aria-hidden="true" tabindex="-1" class="hash-link" href="#constant-initialization-to-the-rescue" title="Direct link to heading">#</a></h3><p>Let&#x27;s make our example slightly more complicated, <strong>disable all
optimizations</strong>, but have a <code>constexpr</code> constructor:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">State</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">constexpr</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">State</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> value1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> value3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">get_value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> State </span><span class="token function" style="color:rgb(130, 170, 255)">optimize_me</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">42</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p><code>constexpr</code> functions are a mechanism through which programmers express their
desire to have the function evaluated at compile time if the function is called
with compile time constant arguments.<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup></p><p>Because our static variable is now initialized with a constant expression, the
IR for this function now becomes much simpler:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-llvm codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@_ZZ9get_valuevE11optimize_me = internal global %struct.State { i8 1, i8 2, i8 3 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">define i32 @_Z10get_valuev() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ret i32 42</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>To emphasize, this happens with no optimizations, this is a built in mechanism
of the language, not a compiler transformation. <a href="https://godbolt.org/z/Y7cGqx" target="_blank" rel="noopener noreferrer">See for yourself</a>!</p><p>What happened here? Constant initialization took place, because we have a
constant expression (the constructor is <code>constexpr</code> and it is called with
constant arguments) initializing the <code>optimize_me</code> variable.</p><p>In the non-<code>constexpr</code> version, the IR global variable corresponding to the C++
static variable was initialized by <code>zeroinitializer</code>, and inside the
<code>get_value</code> function we had a constructor call wrapped by some boilerplate to
ensure the variable was initialized exactly once. In other words, <strong>zero
initialization + runtime initialization</strong> took place.</p><p>In the <code>constexpr</code> version, all the boilerplate is gone because <strong>constant
initialization happened instead of zero-initialization + runtime
initialization</strong>. This is the core idea of this post: if you enable constant
initialization, unnecessary code disappears.</p><p>The generated assembly contains the already-initialized variable in the
data segment of the program:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">get_value()::optimize_me:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .byte   1                       # 0x1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .byte   2                       # 0x2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .byte   3                       # 0x3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        .size   get_value()::optimize_me, 3</span></div></div></div></div></div><p>With optimizations enabled, the static variable will be completely removed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dont-let-slow-code-compile"></a>Don&#x27;t let slow code compile.<a aria-hidden="true" tabindex="-1" class="hash-link" href="#dont-let-slow-code-compile" title="Direct link to heading">#</a></h2><p>C++20 adds a new keyword <code>constinit</code> to ensure a variable only has constant
initialization, otherwise the program is ill-formed. For example, the following
code does not compile (note the absence of a <code>constexpr</code> constructor):</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button tabindex="0" type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div class="prism-code language-cpp codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">State</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">State</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> value1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> value3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">c3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">char</span><span class="token plain"> value3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">get_value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  constinit </span><span class="token keyword" style="font-style:italic">static</span><span class="token plain"> State </span><span class="token function" style="color:rgb(130, 170, 255)">optimize_me</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">42</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div></div></div><p>This is desirable because it prevents inefficient code from compiling.  If we
make <code>State</code>&#x27;s constructor <code>constexpr</code>, the program is now legal and uses
efficient constant initialization. <a href="https://godbolt.org/z/TxrgSv" target="_blank" rel="noopener noreferrer">Godbolt link</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="but-we-cant-constexpr-all-the-things"></a>But we can&#x27;t constexpr all the things<a aria-hidden="true" tabindex="-1" class="hash-link" href="#but-we-cant-constexpr-all-the-things" title="Direct link to heading">#</a></h2><p>The original example dealt with a <code>std::string</code> static variable, which may
perform dynamic memory allocation - which is not allowed in <code>constexpr</code>
contexts. This is lifted in C++20 and most methods of <code>std::string</code> are made
<code>constexpr</code> thanks to [Louis Dionne&#x27;s paper]. No compilers implement this at the
time of writing, but you can check <a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/status.html#status.iso.2020" target="_blank" rel="noopener noreferrer">GCC&#x27;s progress</a> and <a href="https://libcxx.llvm.org/cxx2a_status.html" target="_blank" rel="noopener noreferrer">Clang&#x27;s progress</a> on
their websites.</p><p>Edit (2020-03-21): As Jason Turner pointed out on Twitter, <code>constexpr</code> dynamic
allocation, while allowed in C++ 20, still needs to be freed in the same
<code>constexpr</code> context that allocated it. This implies that big <code>constexpr</code> strings
are not going to be allowed.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="conclusion"></a>Conclusion<a aria-hidden="true" tabindex="-1" class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Without entering the discussion of when/if static variables should be used,
it&#x27;s important to be aware of the price that is paid for their correct
initialization. In most cases, the programmer can completely avoid this price
by using constant initialization (usually in the form of <code>constexpr</code> constructors
and functions).</p><p>Furthermore, by expressing their intent properly to the compiler, it&#x27;s possible
to ensure a compilation error when code changes trigger inefficient
initialization; this is accomplished by marking the static variable as
<code>constinit</code>. A lot of new features in the C++ language are driven by the desire
to allow programmers to communicate intent to the compiler (and to other
programmers).</p><p>I also hope to have shown that using the LLVM IR makes it simpler to explore
architecture-agnostic missed optimizations. In the case explored here, there is
no reason why a static variable should be optimized away when targeting x86,
but not when targeting ARM, for instance.</p><div class="footnotes"><hr><ol><li id="fn-1">We&#x27;re compiling the code without support for thread-safe static
initialization to keep things simple. However, most of our conclusion still
hold if we enable thread safe statics.<a href="#fnref-1" class="footnote-backref">â†©</a></li><li id="fn-2">If you&#x27;re curious why, the creator of C++ answers it in <a href="http://www.stroustrup.com/bs_faq2.html#sizeof-empty" target="_blank" rel="noopener noreferrer">his website</a>.<a href="#fnref-2" class="footnote-backref">â†©</a></li><li id="fn-3">Other challenges are possible. For example, if
this function gets inlined elsewhere, we will have multiple functions accessing
the same global variable and the compiler will struggle reasoning about this.
Note also that we don&#x27;t have to consider other translation units because static
variables have internal linkage, that is, they can only be accessed from the
translation unit in which it is defined; this is represented by the <code>internal</code>
keyword in IR.<a href="#fnref-3" class="footnote-backref">â†©</a></li><li id="fn-4">There is a stronger form of this in the form of
the <code>consteval</code> keyword. When applied to a function, it is a compile-time error
if the function is not evaluated at compile time. It is a useful mechanism to
ensure that an expensive function is never evaluated during program
execution.<a href="#fnref-4" class="footnote-backref">â†©</a></li></ol></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/20200503-git_intro/README"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« A Git introduction with no commands</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/20200222-build_systems2/README"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Build system basics - part 2 Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-offending-code" class="table-of-contents__link">The offending code.</a></li><li><a href="#optimized-code" class="table-of-contents__link">Optimized code</a><ul><li><a href="#static-storage" class="table-of-contents__link">Static storage</a></li><li><a href="#zero-or-constant-initialization" class="table-of-contents__link">Zero or Constant initialization</a></li><li><a href="#constant-initialization-to-the-rescue" class="table-of-contents__link">Constant initialization to the rescue!</a></li></ul></li><li><a href="#dont-let-slow-code-compile" class="table-of-contents__link">Don&#39;t let slow code compile.</a></li><li><a href="#but-we-cant-constexpr-all-the-things" class="table-of-contents__link">But we can&#39;t constexpr all the things</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/styles.9959f271.js"></script>
<script src="/runtime~main.5df455bb.js"></script>
<script src="/main.01c6edad.js"></script>
<script src="/1.43c5d01a.js"></script>
<script src="/2.cf4e590e.js"></script>
<script src="/13.c5726d0f.js"></script>
<script src="/935f2afb.584f3aef.js"></script>
<script src="/17896441.2afc73b6.js"></script>
<script src="/7327e912.34065dcc.js"></script>
</body>
</html>